<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.5"/><style data-href="/styles.574ccb2304c189c50186.css" data-identity="gatsby-global-css">body{font-family:Arial,Helvetica,sans-serif;font-size:17px;line-height:22px;margin:0}._404-module--content--39436{background-color:#fafafa;padding:20px}._404-module--content--39436 ._404-module--header--15698{color:red}._404-module--content--39436 ._404-module--error-message--76252{color:gray;font-size:20px}.layout-module--container--46809{min-height:100vh;position:relative}.layout-module--container--46809 .layout-module--content--1704e{margin:0 auto;max-width:960px;padding-bottom:100px}.layout-module--container--46809 .layout-module--content--1704e a{color:#000}@media screen and (min-width:1px)and (max-width:1000px){.layout-module--container--46809 .layout-module--content--1704e{padding-left:20px;padding-right:20px}}.header-module--container--8b59b{margin:50px auto 0;max-width:960px;min-height:140px;padding-top:30px}.header-module--container--8b59b .header-module--row--3cc44{padding:5px;text-align:center}.header-module--container--8b59b .header-module--button--31197,.header-module--container--8b59b .header-module--button-github--f7d0c,.header-module--container--8b59b .header-module--button-icon--94669,.header-module--container--8b59b .header-module--button-linkedin--6c28d,.header-module--container--8b59b .header-module--button-twitter--6bc47{background-color:#222f3e;color:#fff;display:inline-block;font-family:Verdana,Geneva,Tahoma,sans-serif;font-size:12px;font-weight:700;height:30px;line-height:30px;margin-bottom:10px;margin-right:10px;min-width:15px;padding-left:10px;padding-right:10px;text-transform:uppercase}.header-module--container--8b59b .header-module--button--31197:hover,.header-module--container--8b59b .header-module--button-github--f7d0c:hover,.header-module--container--8b59b .header-module--button-icon--94669:hover,.header-module--container--8b59b .header-module--button-linkedin--6c28d:hover,.header-module--container--8b59b .header-module--button-twitter--6bc47:hover{background-color:#0984e3}.header-module--container--8b59b .header-module--button-github--f7d0c,.header-module--container--8b59b .header-module--button-icon--94669,.header-module--container--8b59b .header-module--button-linkedin--6c28d,.header-module--container--8b59b .header-module--button-twitter--6bc47{background-position:50%;background-repeat:no-repeat;background-size:16px 16px}.header-module--container--8b59b .header-module--button-github--f7d0c{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMFzkb2YICAAAA6klEQVQoz42RP0oDcRhE3y8gaFIJplAhWgXcQJoFwT6VkCJlDpALeAALS8scwBPEK+gBTCGCf1hwYRU3zRYWhsTqWShBiKu+8mOYYb6Bv7Fr3+rStWrfLgTwloiCY+7ZZAvImbDHCRvchRZgYRkFVICsND0DbDordZjZxJG/MQpmNIArLnhnnRryxis1DomAJ5yq5wZj40XF2NgVL9UpJuoumJouBKkpuK8mFcZI/mOHHBhjRz34tP0eAfbUDuDQa3eWXt320SEEAAcc8UJCwZzAKnVa1DkNZ18CACPabLOGzHnmJjz8Y2eAD7/5vvjSJOIHAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTEwLTI0VDEyOjIzOjU3KzAyOjAwzxYwVwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0xMC0yNFQxMjoyMzo1NyswMjowML5LiOsAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAAAAElFTkSuQmCC)}.header-module--container--8b59b .header-module--button-twitter--6bc47{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMIBW5Bk7VAAAA0ElEQVQoz4WRvWoCYRRE5xN0GxEb0Wq1CIKdYGGRQlIL+ggW8YFWSJEUtr6AjaCihVVsBUMkEEgtdsE/ciyM+q2r7Cnv3Bkuc6UQTHBERlVF1TdfEgnh0CJmyRVWAKx5Y0BKPAET0ueFby4MaYg8AD80cSVy2LSPnv558EHHt1CTRJExf9zGPSYs7shLSYpIetbnzQpGp7sdXlgH/Bvy/wlmo7mcgN8zdi4luj7/lPhFTPLIKztL9qxuKdOzpF8m1APPIquCHrTVu2ZmH/bfKw47VepU/0v6uQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMC0yNFQxMjozMjoyMSswMjowMIhPuIoAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTAtMjRUMTI6MzI6MjErMDI6MDD5EgA2AAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAABJRU5ErkJggg==);margin-right:0}.header-module--container--8b59b .header-module--button-linkedin--6c28d{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMHzpKCVmwAAAAi0lEQVQoz82QIQ7CQBBF3zYISBpO0XABDAaFQdaSIFZwoJ4DRYIjnAIcqoYKLAd4iJISsjQIDE9M/mT+/EwGV9buzenDWtXYN884Azzrx4Tc6JQfsKV6KYeu3Xn3aAGDZGPMgTkAC04uU0MkdHrEJksMgSslM24AlOkNjRMAq7ZNE7bh8v6oL/yD4QFJWUru4kp6/AAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMC0yNFQxMjozMTo1OCswMjowMPwlT0MAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTAtMjRUMTI6MzE6NTgrMDI6MDCNePf/AAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAABJRU5ErkJggg==)}.header-module--container--8b59b .header-module--link--8ce94{color:#222f3e;font-family:Verdana,Geneva,Tahoma,sans-serif;font-size:17px;font-weight:700;text-decoration:none}.header-module--container--8b59b .header-module--link--8ce94:hover{color:#0984e3}.header-module--container--8b59b .header-module--link--8ce94:not(:last-child){padding-right:30px}.footer-module--container--e4696{background-color:#222f3e;bottom:0;height:100px;position:absolute;width:100%}.footer-module--container--e4696 .footer-module--footer--675c6{color:#fff;font-family:Verdana,Geneva,Tahoma,sans-serif;height:100px;line-height:100px;margin:0 auto;max-width:960px;padding:0 20px}.title-module--container--9830f{border-bottom:5px solid #576574;color:#576574;margin-bottom:30px;padding-bottom:10px;text-align:center;text-transform:uppercase}.title-module--container--9830f .title-module--title--71b50{font-size:50px;line-height:60px}.title-module--container--9830f .title-module--subtitle--0d166{font-size:18px;font-weight:100}.article-module--article-box--1af62{border-bottom:1px dotted #777;box-shadow:inset 0 0 0 0 #fff;display:inline-block;margin-bottom:30px;transition:all .25s ease;width:100%}.article-module--article-box--1af62:hover{cursor:pointer}@media screen and (min-width:960px){.article-module--article-box--1af62:hover{box-shadow:inset 960px 0 0 0 #dfe6e9}}.article-module--article-box--1af62 .article-module--left--302a9{background-color:#fafafa;float:left;height:150px;width:150px}.article-module--article-box--1af62 .article-module--right--75d6f{color:#222f3e;margin-left:150px;margin-top:-20px;padding:15px}.article-module--article-box--1af62 .article-module--right--75d6f .article-module--date--8c592{font-size:12px;margin-bottom:20px;margin-top:-15px}.article-module--article-box--1af62 .article-module--right--75d6f h3{color:#222f3e}.post-module--container--7b4d6 .post-module--content--b6718{padding:20px}.post-module--container--7b4d6 .post-module--content--b6718 h1{color:#222f3e;line-height:50px;margin-bottom:30px}.post-module--container--7b4d6 .post-module--content--b6718 h2{color:#576574;line-height:30px;margin-bottom:30px;margin-top:30px}.post-module--container--7b4d6 .post-module--content--b6718 h3{color:#576574;line-height:25px;margin-bottom:30px;margin-top:30px}.post-module--container--7b4d6 .post-module--content--b6718 p{font-size:18px;line-height:30px;margin-bottom:10px;text-align:justify}</style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--46809"><header class="header-module--container--8b59b"><div class="header-module--row--3cc44"><a href="/"><div class="header-module--button--31197">Jake the dev</div></a><a href="https://www.github.com/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-github--f7d0c"> </div></a><a href="https://www.linkedin.com/in/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-linkedin--6c28d"> </div></a><a href="https://twitter.com/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-twitter--6bc47"> </div></a></div><div class="header-module--row--3cc44"><a class="header-module--link--8ce94" href="/">ARTICLES</a><a class="header-module--link--8ce94" href="/about">ABOUT</a></div></header><div class="layout-module--content--1704e"><div class="post-module--container--7b4d6"><div style="width:100%;height:640px;background-color:#fafafa;background-image:Url(https://picsum.photos/seed/architecture/960/640);background-size:cover;background-repeat:no-repeat;margin-bottom:30px"></div><section class="title-module--container--9830f"><h1 class="title-module--title--71b50">ASP.NET Core로 구현하는 클린 아키텍쳐 (4)</h1><div class="title-module--subtitle--0d166"></div></section><div class="post-module--content--b6718"><p>지난편에 이어서 애플리케이션 레이어를 완성할 것이다. 조회 요청을 다루면서 DTO(Data Transfer Object)를 효율적으로 정의하고 매핑을 자동화하는 방법을 알아본다. 몇 가지 예외를 정의하고 다른 레이어에서 적절히 사용할 수 있도록 한다.</p>
<!--more-->
<blockquote>
<ul>
<li><a href="/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90-1">ASP.NET Core로 구현하는 클린 아키텍쳐 (1)</a></li>
<li><a href="/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90-2">ASP.NET Core로 구현하는 클린 아키텍쳐 (2)</a></li>
<li><a href="/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90-3">ASP.NET Core로 구현하는 클린 아키텍쳐 (3)</a></li>
</ul>
</blockquote>
<h2>유스케이스 구현</h2>
<p>전편에서는 결재 요청에 대한 정보를 저장하는 유스케이스를 <strong>커맨드</strong>로 구현했으니 이번에는 그 내용을 조회하는 <strong>쿼리</strong> 객체를 구상해보자.</p>
<h4>(유스케이스 #2) 단일 결재 조회하기</h4>
<p>먼저, 유닛테스트를 통해 쿼리 객체를 어떻게 사용하게 될지, 반환값을 어떻게 정의할지 구성해본다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">[Fact]
public async Task Handler_GivenExistingId_ShouldReturnAPaymentRecord()
{
    var payment = new Payment(1, &quot;cardholder1&quot;, &quot;1111-2222-3333-4444&quot;, &quot;12/22&quot;, &quot;111&quot;, 1000);
    
    await context.Payments.AddAsync(payment);
    await context.CommitAsync(CancellationToken.None);
    
    var query = new GetPaymentDetailQuery
    {
        Id = payment.Id
    };
    var sut = new GetPaymentDetailQuery.Handler(context, mapper);

    var result = await sut.Handle(query, CancellationToken.None);
    result.Should().BeOfType&lt;PaymentDetailDto&gt;();
    result.CardHolderName.Should().Be(&quot;cardholder1&quot;);
}</code>
        </deckgo-highlight-code>
<p>쿼리 객체의 이름은 <code>GetPaymentDetailQuery</code> 처럼 쿼리로 끝난다. 대부분의 엔티티 조회가 그렇듯 ID를 조회조건으로 사용한다. 쿼리의 반환값으로 <code>Payment</code> 엔티티가 아닌 DTO(<code>PaymentDetailDto</code>)를 정의했다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class PaymentDetailDto
{
    public Guid Id { get; set; }
    public string CardHolderName { get; set; }
    public string MaskedCardNumber { get; set; }
    public decimal Amount { get; set; }
}</code>
        </deckgo-highlight-code>
<p><code>Payment</code> 엔티티는 7개의 속성이 있지만 <code>PaymentDetailDto</code>를 사용하여 꼭 필요한 4개의 속성만 노출하고 있다. 또한, 마스킹된 카드번호를 반환하기 때문에 DTO가 꼭 필요한 경우라고 할 수 있다. 여기서 잠깐 아키텍쳐 내에서 DTO의 역할을 짚고 넘어가자.</p>
<h4>Interface Adapters 레이어</h4>
<p>클린 아키텍쳐 관점에서 다시 생각해보면, 레이어의 경계에서 달라지는 데이터 모델을 관리하기 위해 Interface Adapters라는 별도 레이어를 애플리케이션 레이어 밖에 위치시켰다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/af89b5c0f691120331855d1e637e6603/e0885/architecture-transform.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 41%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKklEQVQozy2S3UtTARjG94fUZZDXXRQUXQXVbUR3QXaVgpSlqaMIQRSLhGWYmWU2mWSK38XEjH2kc859uM2znbPtzOM8H7OdiYpgtv3K2XP5Prw/Hngei64b/No2MDQdWcqSiUfRZAFFipGTJXTDQNd1NE2jVCpRKpc51t7+IT/CJnOrBfLmQeVWLpexGLpKIrXFSFCmezXA+0AcVzDNtq5SMAuYpkmxWERVVQ5/H1Uew1KRay1hbjS7uNWywOWHQZx+o+JZkmKWV+5lepRJhmdtfIx94kXMgyeioCop1gUBQRAQRek4A7v7h1y1rvGoth258zpK5xWe33/MhboA6a09LE5/Cps8T3S2h/zUWzYd3diTw/QtRwiuBvH5fIQiEdIZuZLAGzW52egkZ60i3FuD952V3SenudMwgmNBwzLuS2ATJsgO2tgQ7ZhjvYx7+7EFVghKSWQlTVZIoGwoFaArUqDaOo1uPcPim3qc/W3sPz1FbZMd+7yGxbMi8sw9w4jzJdmh1yyNdtG2OMCgO8xSyk8sGiL4+QuZRKICNAoHXKoP0fWggWJrFcXWszga73Luno+ItIMlt6kw6onTHvhOx8ogHWtT9HjCCGIWNa+hrEuER8fIiiJHf0oVqNOf52LdMrebZqhunuB8zU8+fNs8KSWXy5FJp3C6QnQPTeCYchONichyipnoPEsBL4HJadLJJOX/0zhWZmuPgTmdvq8akdTOyWz+Af8CpLkRSKo26O8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="architecture-transform"
        title="architecture-transform"
        src="/static/af89b5c0f691120331855d1e637e6603/5a190/architecture-transform.png"
        srcset="/static/af89b5c0f691120331855d1e637e6603/772e8/architecture-transform.png 200w,
/static/af89b5c0f691120331855d1e637e6603/e17e5/architecture-transform.png 400w,
/static/af89b5c0f691120331855d1e637e6603/5a190/architecture-transform.png 800w,
/static/af89b5c0f691120331855d1e637e6603/e0885/architecture-transform.png 918w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Interface Adapters에 위치하고 있는 <code>Controller</code>와 <code>Presenter</code>가 어떤 역할을 하는지 아래 그림을 통해 자세히 알아보자.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 742px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/28c80a162b6352becad0c68dc6e2d918/0f2bc/user-interactor-flow.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 71.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADuUlEQVQ4y5VTXUyTBxQ939d+tKVFKEMoDrrAUiksjA6XuYDdkonBnwRBZJmyZANRNlAQLINSJpZibb+iUCM/gwqMB01Gtkn5CSP7iRoVFhzEDvlxA91sgUYScHHJfNhdvoSYLHEPO/flPtx7bu655wLPRxD2adk46mHSh5rZ4+2XmabeMUbXVCqK3J0SAC0kABRXy6oSlhyO7712+7iP5y+/pdFI/sXCCBEaCARyQSAX4q9ZkDnkwsl2N05Ut8NChEtEIOldue31tpiFUney39r21dSp2qFF3uHUqlRy+KemAJMJLBGQmsKEe9sRAMgxlhOROM7rDnzdpbM09ambG394cVe3I3lXf/ObJZe+SAIQsOJ0y6bLu9JGyo7qb1fXJAZJpQEgYeIgYW+ek92o0sgUx9KlAEQxP1lsoQ9OkWSxmpQz1bUbPaYiqd9E0mUTiXyGC0LfYFXN2z6rk+YsdeS188tH9HoZnhBx/bY11DwldBEhzTyE3ljXpqwrnyXBV7gdD4rT4TscDW9eBPzH07FUskPkKdYCEM/WdyvvGVvzb1QaPpwx1+2MViolmDrZHZvb4TkQNXjzetjQ9Vtx7h8tVzYYwhufTgL3C4CHR4GVImClEFgzAL8fA6hPkFzy2N6p9p9pdS9Y60e8dr41Wa2W4Zqp4aWczsnMl92jAzH9t0bDvrlhFFZ+L9rKYq0QoE8B2gdQKkCVwOOPMAINIxCu2jvVi6dbvpy1mAeWHQ2NmyMiFJj9ZS7Daf4L2asECHq+RvKcTftD8Sc4kCEEVBoCSuNAr4pAJSGg8mBczQ4EIKPzfwSMFfQk1WXt1N6sMIaLWFaC2XtzoL8J26o7xIiE9P2Kxg334YpSTFXYJF4jSXxGCvZ8Yg6bNBYLB5I8rCLZfEWLcJRva8x6v+0CzVvraeXcOW+WTifH7PQM+85FF7C6hB3JuQwIyMe24Iy+1tRX7jTkJ9xxHMoc6HjjYH9PkmbCeiRu0nYoZ7h7RxH2Ku46+dDfattOjJuM5V47/65WpZI+M7VUtJ6/IKgDRe6vw4i7bYXWwyNjxIU9nQ3Q0XfYThMAecGntsTOfzys8Zo7KqfNZtOiw5GrlAUGPSOMD4mHiBFBLPgBbFBCYY44cfWiKO5nXrzH3cIWeEaYyM8Pc6q8NFmUPkbQUDpR5tz6yHHet2A9/eTR2bOjW9RqOf7zl4VPfA44loNWuZkRM5ziTEIn9FvBHdySwiWro8QyjsP/JlwHu16DXsNutOd+gIb92RAxDP4B7jZ53oj5BVYAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="user-interactor-flow"
        title="user-interactor-flow"
        src="/static/28c80a162b6352becad0c68dc6e2d918/0f2bc/user-interactor-flow.png"
        srcset="/static/28c80a162b6352becad0c68dc6e2d918/772e8/user-interactor-flow.png 200w,
/static/28c80a162b6352becad0c68dc6e2d918/e17e5/user-interactor-flow.png 400w,
/static/28c80a162b6352becad0c68dc6e2d918/0f2bc/user-interactor-flow.png 742w"
        sizes="(max-width: 742px) 100vw, 742px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<ul>
<li>사용자는 View를 통해 애플리케이션을 사용하고 있다. 요청하고 응답을 받는 창이다.</li>
<li>뷰에서 요청을 만들고 컨트롤러가 이를 받는다.</li>
<li>컨트롤러는 이 요청을 애플리케이션이 이해할 수 있는 모델 즉, input port로 정의한 형식으로 변환한다. 그리고, Usecase Interactor로 넘긴다.</li>
<li>Usecase Interactor는 요청을 처리하여 output port에 정의된 형식으로 결과를 작성한다.</li>
<li>프레젠터는 이 결과치를 view model로 변환하여 사용자가 보고 있는 뷰에 전달한다.</li>
</ul>
<p>이렇게까지 복잡한 형변환이 왜 필요한걸까?</p>
<p>레이어의 경계에서 모든 화살표는 왼쪽에서 오른쪽으로 향한다. 즉, 종속성의 방향이 일관되게 바깥에서 안쪽으로 향하고 있다는 의미다. 이쯤되면 클린 아키텍쳐는 종속성의 흐름(방향)에 대해 아주 엄격한 걸 넘어서 강박적이라고도 할만하다.</p>
<p>이 레이어에서 일어나는 형변환을 좀더 쉽게 처리하기 위해 컨트롤러 대신 커맨드 &#x26; 쿼리로 요청을 캡슐화했다. 그리고, 프레젠터의 역할을 DTO로 대신하고 있는 것이다.</p>
<p>DTO는 모델 정의에 있어 도메인 엔티티와 상당히 유사하다. 혹시라도, 귀찮다는 이유로 엔티티를 직접 노출한다면 외부적인 요인때문에 엔티티를 변경해야 하는 상황에 직면할 수 있다. 그래서, DTO와 엔티티의 구조가 일치하더라도 DTO를 사용하는 것이 장기적인 유지보수 관점에서 필요하다고 할 수 있다.</p>
<p>그러나, DTO를 정의하고 사용하는 것은 사실 꽤 귀찮은 일이다. AutoMapper를 사용해서 이 문제를 해결해 보자.</p>
<h4>AutoMapper</h4>
<p><a href="https://docs.automapper.org/en/latest/Getting-started.html">AutoMapper</a>는 객체와 객체를 규칙에 의해 매핑해주는 툴이다. 예를 들어, 소스와 타겟 객체의 속성을 똑같은 이름으로 정해주면 (네이밍 컨벤션에 따라) 최소한의 노력으로 매핑이 완성된다.</p>
<p>최소한의 노력이란 <code>CreateMap()</code> 메서드를 사용하여 AutoMapper의 프로필에 소스와 타겟 객체간의 연관성을 등록해야 하는 일이다. 이 과정을 자동화 시켜보자.</p>
<p><code>DtoBase</code>라는 추상 클래스를 정의하면서 제네릭 인자로 엔티티 타입을 기대한다. 또한, <code>Mapping</code>이라는 메서드를 <code>virtual</code>로 정의하여 자식 클래스에서 오버라이드할 수 있도록 한다. 자식클래스에서 오버라이드하지 않을 경우에는 AutoMapper 프로필에 가장 단순한 매핑을 추가하게 된다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public abstract class DtoBase&lt;T&gt;
{
    public virtual void Mapping(Profile profile) =&gt; profile.CreateMap(typeof(T), GetType());
}</code>
        </deckgo-highlight-code>
<p><code>T</code> 라는 제네릭 인자는 엔티티 타입이므로 <code>CreateMap(source, target)</code> 메서드에서 소스에 위치하고 <code>DtoBase</code>의 자식 클래스가 타켓이 된다. 별도의 명시적인 매핑이 필요 없다면 이 방식을 통해 간단하게 매핑을 마칠 수 있다.</p>
<p>다음 코드는 <code>Payment</code> 엔티티를 <code>PaymentDetailDto</code>로 매핑하는 과정이다. 특별한 경우, 추가적인 매핑이 필요할때만 <code>Mapping</code> 메서드를 오버라이드하는데 이 경우가 그 예라고 할 수 있다. 엔티티에서 <code>CardNumber</code>라는 Value Object의 <code>MaskedValue</code> 속성을 DTO의 <code>MaskedCardNumber</code> 속성에 매핑한다. 네이밍 컨벤션에 의해 처리할 수 없기 때문이다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class PaymentDetailDto : DtoBase&lt;Payment&gt;
{
    public Guid Id { get; set; }
    public string CardHolderName { get; set; }
    public string MaskedCardNumber { get; set; }
    public decimal Amount { get; set; }

    public override void Mapping(Profile profile)
    {
        profile.CreateMap&lt;Payment, PaymentDetailDto&gt;()
            .ForMember(d =&gt; d.MaskedCardNumber, opt =&gt; 
                opt.MapFrom(src =&gt; src.CardNumber.MaskedValue));
    }
}</code>
        </deckgo-highlight-code>
<p>마지막으로, <code>DtoBase</code>를 상속하는 모든 클래스를 자동으로 등록하려고 한다. 아래 코드는 AutoMapper 문서가 제안하는 가장 깔끔한 프로필 관리 방식이다. Profile 클래스를 상속한 후, 생성자에서 필요한 매핑을 하는 것이, 다시말해 <code>CreateMap()</code> 메서드를 사용하는 것이 일반적으로 매핑을 등록하는 방식이다.</p>
<p>이렇게 Profile을 상속해서 별도의 파일에서 매핑을 다루면, 매핑이 필요한 수만큼의 새로운 클래스가 발생할 것이다. 여기서는 단하나의 대표 프로필, <code>MappingProfile</code>을 사용해서 어셈블리에 있는 모든 DTO 클래스를 자동으로 등록하려고 한다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class MappingProfile : Profile
{
    public MappingProfile()
    {
        ApplyMappingsFromAssembly(Assembly.GetExecutingAssembly());
    }

    private void ApplyMappingsFromAssembly(Assembly assembly)
    {
        var types = assembly.GetExportedTypes()
            .Where(t =&gt; 
                t.BaseType != null &amp;&amp; t.BaseType.Name.Contains(&quot;DtoBase&quot;))
            .ToList();

        foreach (var type in types)
        {
            var instance = Activator.CreateInstance(type);
            var methodInfo = type.GetMethod(&quot;Mapping&quot;);
            methodInfo?.Invoke(instance, new object[] {this});
        }
    }
}</code>
        </deckgo-highlight-code>
<p><code>ApplyMappingsFromAssembly()</code> 메서드는 DtoBase를 상속하는 모든 자식 클래스를 찾아서 <code>Mapping()</code> 메서드를 실행한다. 그 결과로, 각각의 매핑이 생성되고 등록된다.</p>
<p>애플리케이션에서는 매핑관련 구체적인 정보를 스스로 구성하고 있지만 이 정보를 등록하는 일은 외부에서 벌어진다. 테스트 프로젝트에서 매핑 정보를 어떻게 등록하고 사용하는지 살펴보자.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">[Collection(&quot;QueryCollection&quot;)]
public class GetPaymentDetailQueryTests
{
    private readonly CheckoutDbContext context;
    private readonly IMapper mapper;

    public GetPaymentDetailQueryTests(QueryTestFixture fixture)
    {
        context = fixture.Context;
        mapper = fixture.Mapper;
    }

    [Fact]
    public async Task Handler_GivenExistingId_ShouldReturnAPaymentRecord()
    {
        var payment = new Payment(1, &quot;cardholder1&quot;, &quot;1111-2222-3333-4444&quot;, &quot;12/22&quot;, &quot;111&quot;, 1000);
        
        await context.Payments.AddAsync(payment);
        await context.CommitAsync(CancellationToken.None);
        
        var query = new GetPaymentDetailQuery
        {
            Id = payment.Id
        };
        var sut = new GetPaymentDetailQuery.Handler(context, mapper);

        var result = await sut.Handle(query, CancellationToken.None);
        result.Should().BeOfType&lt;PaymentDetailDto&gt;();
        result.CardHolderName.Should().Be(&quot;cardholder1&quot;);
    }
}</code>
        </deckgo-highlight-code>
<p>테스트 대상(sut)를 정의하는 곳에서 GetPaymentDetailQuery.Handler를 생성하기 위해 mapper가 필요하다. 이 것은 생성자에 전달된 TestFixture를 통해 초기화하고 있다. TestFixture는 xUnit 테스트에서 여러 클래스에서 정보를 공유하기 위한 기법인데 다음과 같이 정의하여 사용한다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class QueryTestFixture : IDisposable
{
    public CheckoutDbContext Context { get; private set; }
    public IMapper Mapper { get; private set; }

    public QueryTestFixture()
    {
        Context = CheckoutDbContextFactory.Create();

        var configurationProvider = new MapperConfiguration(cfg =&gt;
        {
            cfg.AddProfile&lt;MappingProfile&gt;();
        });

        Mapper = configurationProvider.CreateMapper();
    }

    public void Dispose()
    {
        CheckoutDbContextFactory.Destroy(Context);
    }
}

[CollectionDefinition(&quot;QueryCollection&quot;)]
public class QueryCollection : ICollectionFixture&lt;QueryTestFixture&gt; { }</code>
        </deckgo-highlight-code>
<p>데이터베이스 컨텍스트와 함께 매퍼도 생성하고 있는데, 앞서 정의한 MappingProfile 하나만을 추가하지만 그것이 어떤 영향을 끼치는지 상기해보자.</p>
<p>쿼리 객체를 구현하기에 앞서 사설이 길었다. 완성된 코드는 아래와 같다. 예상대로 간단 명료하다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class GetPaymentDetailQuery : IRequest&lt;PaymentDetailDto&gt;
{
    public Guid Id { get; set; }

    public class Handler : IRequestHandler&lt;GetPaymentDetailQuery, PaymentDetailDto&gt;
    {
        private readonly ICheckoutDbContext context;
        private readonly IMapper mapper;

        public Handler(ICheckoutDbContext context, IMapper mapper)
        {
            this.context = context;
            this.mapper = mapper;
        }

        public async Task&lt;PaymentDetailDto&gt; Handle(GetPaymentDetailQuery request,
            CancellationToken cancellationToken)
        {
            var payment = await context.Payments
                .SingleOrDefaultAsync(p =&gt; p.Id == request.Id, cancellationToken: cancellationToken);

            if (payment == null)
            {
                throw new EntityNotFoundException(nameof(Payment), request.Id);
            }

            return mapper.Map&lt;PaymentDetailDto&gt;(payment);
        }
    }
}</code>
        </deckgo-highlight-code>
<ul>
<li>쿼리 조건으로는 <code>Id</code>만 정의하고 있다.</li>
<li>핸들러를 사용하기 위해 데이터베이스 컨텍스트와 매퍼가 필요하다.</li>
<li>핸들러는 데이터베이스 컨텍스트로 Payment 엔티티를 조회하고 그 결과를 매퍼를 사용하여 DTO로 반한한다.</li>
<li>매핑 정보가 제대로 등록되지 않았다면 이 부분에서 에러가 발생할 것이다.</li>
</ul>
<h2>예외 처리</h2>
<p>앞선 코드에서 조회 결과가 없으면 어떤 피드백이 있어야 한다. 애플리케이션 레이어에서는 예외를 체계적으로 정의해서 발생시키는 것으로 그 의무를 다하고, 그 예외를 잡아서 사용자에게 안내하는 일은 프레젠테이션 레이어에 존재하는 프로젝트들의 몫이다. 예외는 원하는 만큼 정의할 수 있지만 HTTP Status와 연관해서 생각하는 것이 좋다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class EntityNotFoundException : Exception
{
    public EntityNotFoundException(string name, object key)
        : base($&quot;Entity \&quot;{name}\&quot; ({key}) was not found.&quot;)
    {
    }
}</code>
        </deckgo-highlight-code>
<p>위의 예외는 해당 엔티티를 찾을 수 없는 경우, 찾으려는 엔티티의 종류와 조회에 사용된 키값을 메시지에 포함하여 찾기에 실패했음을 알리는데 사용한다. 이 쿼리가 Web API에서 사용된다면 404 Not Found 에 딱 맞는 예외다.</p>
<p>비슷한 예로, ValidationException을 애플리케이션에서 발생시키면 API 단에서는 400 Bad Request로 변환할 수 있겠다. 이 부분은 API 프로젝트를 구현할 때, 자세히 설명하도록 하겠다.</p>
<h2>(유스케이스 #3) 결재 목록 조회하기</h2>
<p>이번에는 목록 조회를 통해 추가로 몇가지를 살펴보고자 한다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class GetPaymentsListQuery : IRequest&lt;PaymentsListVm&gt;
{
    public int MerchantId { get; set; }
    public string CardNumber { get; set; }

    public class Handler : IRequestHandler&lt;GetPaymentsListQuery, PaymentsListVm&gt;
    {
        private readonly ICheckoutDbContext context;
        private readonly IMapper mapper;

        public Handler(ICheckoutDbContext context, IMapper mapper)
        {
            this.context = context;
            this.mapper = mapper;
        }
        
        public async Task&lt;PaymentsListVm&gt; Handle(GetPaymentsListQuery request, CancellationToken cancellationToken)
        {
            var payments = await context.Payments
                .AsNoTracking()
                .Where(p =&gt; p.MerchantId == request.MerchantId &amp;&amp;
                    p.CardNumber.OriginalValue == request.CardNumber)
                .ProjectTo&lt;PaymentDetailDto&gt;(mapper.ConfigurationProvider)
                .ToListAsync(cancellationToken);
            
            return new PaymentsListVm
            {
                Payments = payments
            };
        }
    }
}</code>
        </deckgo-highlight-code>
<p><code>Handle()</code> 메서드에서 목록을 조회하면서 <code>ProjectTo&#x3C;PaymentDetailDto>()</code>를 사용했다. AutoMapper가 제공하는 <code>IQueryable</code> 인터페이스의 확장인데 LINQ 문장에서 유용하게 사용할 수 있다.</p>
<p>DTO 객체가 집합으로 반환되는 경우에, <code>IEnumerable&#x3C;PaymentDetailDto></code> 형식으로 반환하는 것도 충분히 가능한 일이다. 그러나, 응답 모델에 다른 속성을 추가해야 할 상황이 생기면 이 모델은 유연하지 않다. 그래서 <code>PaymentsListVm</code> 라는 새로운 뷰 모델을 사용했다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class PaymentsListVm
{
    public IList&lt;PaymentDetailDto&gt; Payments { get; set; }
}</code>
        </deckgo-highlight-code>
<p>속성을 추가하기에 훨씬 편한 구조임을 알 수 있다. DTO를 감싸는 형태라서 또 다른 DTO를 사용하는 것보다 뷰 모델이라는 새로운 개념을 적용했다.</p>
<h4><a href="https://github.com/JakeRyu/Checkout/tree/issue%235/query-payment">현재까지 구현된 전체 코드</a></h4>
<h2>중간정리</h2>
<p>이번 글에서는 애플리케이션 레이어에서 Interface Adapters 레이어를 흡수, 구현하는 방법을 CQRS + DTO 조합으로 알아보았다. 특히, AutoMapper를 사용할 때, 매핑을 자동화하는 방법에 많은 지면을 할애했다. 마지막으로, 예외를 어떻게 정의하는지, 추후 다른 레이어에서 그 예외를 어떻게 사용할지, 그 가능성에 대해 언급했다.</p>
<p>애플리케이션 레이어 관련한 두 편의 글에서 아래 내용을 다루었다. 이 것으로 애플리케이션 레이어의 역할을 이해하는데 도움이 되었기를 바란다.</p>
<ul>
<li>인터페이스 정의</li>
<li>유스케이스 구현</li>
<li>커맨드 &#x26; 쿼리 (CQRS)</li>
<li>유효성 검사</li>
<li>예외 정의</li>
</ul>
<p>다음 편에서는 미처 담지 못한 보너스를 소개하면서 애플리케이션 레이어의 완성도를 높여보고자 한다. MediatR의 고급 기능을 통해, 유효성 검사를 자동화하고 애플리케이션의 성능을 로깅하는 법에 대해 알아볼 것이다.</p></div></div></div><footer class="footer-module--container--e4696"><div class="footer-module--footer--675c6">My new Gatsby Blog 2019</div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/클린아키텍쳐-4/";window.___webpackCompilationHash="d6ab49c3a8c79f2344e2";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-31951725b1a6558f9f0d.js"],"app":["/app-f6f44375a15ab67f01d4.js"],"component---src-pages-404-js":["/component---src-pages-404-js-fc551ff7f9f211004b5d.js"],"component---src-pages-about-js":["/component---src-pages-about-js-b7b14074bb3d7bf693c3.js"],"component---src-pages-index-js":["/component---src-pages-index-js-c3be496134cc732b85cf.js"],"component---src-templates-post-js":["/component---src-templates-post-js-d7dcfc11758498b1f5f2.js"]};/*]]>*/</script><script src="/polyfill-31951725b1a6558f9f0d.js" nomodule=""></script><script src="/app-f6f44375a15ab67f01d4.js" async=""></script><script src="/framework-e1920fffb1cf79c01553.js" async=""></script><script src="/webpack-runtime-d251e6d658e77b73ede3.js" async=""></script></body></html>