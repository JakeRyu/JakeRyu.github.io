<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.18.0"/><style data-href="/styles.db05a864f5362495e721.css" data-identity="gatsby-global-css">body{font-family:Arial,Helvetica,sans-serif;font-size:17px;line-height:22px;margin:0}._404-module--content--OUNuJ{background-color:#fafafa;padding:20px}._404-module--content--OUNuJ ._404-module--header--FWmI-{color:red}._404-module--content--OUNuJ ._404-module--error-message--diUlb{color:gray;font-size:20px}.layout-module--container--RoCXy{min-height:100vh;position:relative}.layout-module--container--RoCXy .layout-module--content--FwTjf{margin:0 auto;max-width:960px;padding-bottom:100px}.layout-module--container--RoCXy .layout-module--content--FwTjf a{color:#000}@media screen and (min-width:1px)and (max-width:1000px){.layout-module--container--RoCXy .layout-module--content--FwTjf{padding-left:20px;padding-right:20px}}.header-module--container--i1m8L{margin:50px auto 0;max-width:960px;min-height:140px;padding-top:30px}.header-module--container--i1m8L .header-module--row--PMRLn{padding:5px;text-align:center}.header-module--container--i1m8L .header-module--button--MRlxv,.header-module--container--i1m8L .header-module--button-github--99DPx,.header-module--container--i1m8L .header-module--button-icon--lGaW9,.header-module--container--i1m8L .header-module--button-linkedin--bCjbJ,.header-module--container--i1m8L .header-module--button-twitter--a8R0i{background-color:#222f3e;color:#fff;display:inline-block;font-family:Verdana,Geneva,Tahoma,sans-serif;font-size:12px;font-weight:700;height:30px;line-height:30px;margin-bottom:10px;margin-right:10px;min-width:15px;padding-left:10px;padding-right:10px;text-transform:uppercase}.header-module--container--i1m8L .header-module--button--MRlxv:hover,.header-module--container--i1m8L .header-module--button-github--99DPx:hover,.header-module--container--i1m8L .header-module--button-icon--lGaW9:hover,.header-module--container--i1m8L .header-module--button-linkedin--bCjbJ:hover,.header-module--container--i1m8L .header-module--button-twitter--a8R0i:hover{background-color:#0984e3}.header-module--container--i1m8L .header-module--button-github--99DPx,.header-module--container--i1m8L .header-module--button-icon--lGaW9,.header-module--container--i1m8L .header-module--button-linkedin--bCjbJ,.header-module--container--i1m8L .header-module--button-twitter--a8R0i{background-position:50%;background-repeat:no-repeat;background-size:16px 16px}.header-module--container--i1m8L .header-module--button-github--99DPx{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMFzkb2YICAAAA6klEQVQoz42RP0oDcRhE3y8gaFIJplAhWgXcQJoFwT6VkCJlDpALeAALS8scwBPEK+gBTCGCf1hwYRU3zRYWhsTqWShBiKu+8mOYYb6Bv7Fr3+rStWrfLgTwloiCY+7ZZAvImbDHCRvchRZgYRkFVICsND0DbDordZjZxJG/MQpmNIArLnhnnRryxis1DomAJ5yq5wZj40XF2NgVL9UpJuoumJouBKkpuK8mFcZI/mOHHBhjRz34tP0eAfbUDuDQa3eWXt320SEEAAcc8UJCwZzAKnVa1DkNZ18CACPabLOGzHnmJjz8Y2eAD7/5vvjSJOIHAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTEwLTI0VDEyOjIzOjU3KzAyOjAwzxYwVwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0xMC0yNFQxMjoyMzo1NyswMjowML5LiOsAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAAAAElFTkSuQmCC)}.header-module--container--i1m8L .header-module--button-twitter--a8R0i{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMIBW5Bk7VAAAA0ElEQVQoz4WRvWoCYRRE5xN0GxEb0Wq1CIKdYGGRQlIL+ggW8YFWSJEUtr6AjaCihVVsBUMkEEgtdsE/ciyM+q2r7Cnv3Bkuc6UQTHBERlVF1TdfEgnh0CJmyRVWAKx5Y0BKPAET0ueFby4MaYg8AD80cSVy2LSPnv558EHHt1CTRJExf9zGPSYs7shLSYpIetbnzQpGp7sdXlgH/Bvy/wlmo7mcgN8zdi4luj7/lPhFTPLIKztL9qxuKdOzpF8m1APPIquCHrTVu2ZmH/bfKw47VepU/0v6uQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMC0yNFQxMjozMjoyMSswMjowMIhPuIoAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTAtMjRUMTI6MzI6MjErMDI6MDD5EgA2AAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAABJRU5ErkJggg==);margin-right:0}.header-module--container--i1m8L .header-module--button-linkedin--bCjbJ{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMHzpKCVmwAAAAi0lEQVQoz82QIQ7CQBBF3zYISBpO0XABDAaFQdaSIFZwoJ4DRYIjnAIcqoYKLAd4iJISsjQIDE9M/mT+/EwGV9buzenDWtXYN884Azzrx4Tc6JQfsKV6KYeu3Xn3aAGDZGPMgTkAC04uU0MkdHrEJksMgSslM24AlOkNjRMAq7ZNE7bh8v6oL/yD4QFJWUru4kp6/AAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMC0yNFQxMjozMTo1OCswMjowMPwlT0MAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTAtMjRUMTI6MzE6NTgrMDI6MDCNePf/AAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAABJRU5ErkJggg==)}.header-module--container--i1m8L .header-module--link--jOlJU{color:#222f3e;font-family:Verdana,Geneva,Tahoma,sans-serif;font-size:17px;font-weight:700;text-decoration:none}.header-module--container--i1m8L .header-module--link--jOlJU:hover{color:#0984e3}.header-module--container--i1m8L .header-module--link--jOlJU:not(:last-child){padding-right:30px}.footer-module--container--5GliC{background-color:#222f3e;bottom:0;height:100px;position:absolute;width:100%}.footer-module--container--5GliC .footer-module--footer--Z1xkR{color:#fff;font-family:Verdana,Geneva,Tahoma,sans-serif;height:100px;line-height:100px;margin:0 auto;max-width:960px;padding:0 20px}.title-module--container--mDD1t{border-bottom:5px solid #576574;color:#576574;margin-bottom:30px;padding-bottom:10px;text-align:center;text-transform:uppercase}.title-module--container--mDD1t .title-module--title--cbUG\+{font-size:50px;line-height:60px}.title-module--container--mDD1t .title-module--subtitle--DRZhF{font-size:18px;font-weight:100}.article-module--article-box--GvYiU{border-bottom:1px dotted #777;box-shadow:inset 0 0 0 0 #fff;display:inline-block;margin-bottom:30px;transition:all .25s ease;width:100%}.article-module--article-box--GvYiU:hover{cursor:pointer}@media screen and (min-width:960px){.article-module--article-box--GvYiU:hover{box-shadow:inset 960px 0 0 0 #dfe6e9}}.article-module--article-box--GvYiU .article-module--left--MCqTJ{background-color:#fafafa;float:left;height:150px;width:150px}.article-module--article-box--GvYiU .article-module--right--ddbwg{color:#222f3e;margin-left:150px;margin-top:-20px;padding:15px}.article-module--article-box--GvYiU .article-module--right--ddbwg .article-module--date--jFkoy{font-size:12px;margin-bottom:20px;margin-top:-15px}.article-module--article-box--GvYiU .article-module--right--ddbwg h3{color:#222f3e}.post-module--container--e01vr .post-module--content--tnGN8{padding:20px}.post-module--container--e01vr .post-module--content--tnGN8 h1{color:#222f3e;line-height:50px;margin-bottom:30px}.post-module--container--e01vr .post-module--content--tnGN8 h2{color:#576574;line-height:30px;margin-bottom:30px;margin-top:30px}.post-module--container--e01vr .post-module--content--tnGN8 h3{color:#576574;line-height:25px;margin-bottom:30px;margin-top:30px}.post-module--container--e01vr .post-module--content--tnGN8 p{font-size:18px;line-height:30px;margin-bottom:10px;text-align:justify}</style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--RoCXy"><header class="header-module--container--i1m8L"><div class="header-module--row--PMRLn"><a href="/"><div class="header-module--button--MRlxv">Jake the dev</div></a><a href="https://www.github.com/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-github--99DPx"> </div></a><a href="https://www.linkedin.com/in/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-linkedin--bCjbJ"> </div></a><a href="https://twitter.com/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-twitter--a8R0i"> </div></a></div><div class="header-module--row--PMRLn"><a class="header-module--link--jOlJU" href="/">ARTICLES</a><a class="header-module--link--jOlJU" href="/about">ABOUT</a></div></header><div class="layout-module--content--FwTjf"><div class="post-module--container--e01vr"><div style="width:100%;height:640px;background-color:#fafafa;background-image:Url(https://picsum.photos/seed/generic/960/640);background-size:cover;background-repeat:no-repeat;margin-bottom:30px"></div><section class="title-module--container--mDD1t"><h1 class="title-module--title--cbUG+">제네릭 리포지토리</h1><div class="title-module--subtitle--DRZhF"></div></section><div class="post-module--content--tnGN8"><p>이전 글, <a href="/%EB%A6%AC%ED%8F%AC%EC%A7%80%ED%86%A0%EB%A6%AC-%ED%8C%A8%ED%84%B4">리포지토리 패턴과 엔티티 프레임워크 코어</a>를 읽고 리포지토리 패턴을 구현하기로 결정했다면 이번 글에서는 엔티티 프레임워크 코어를 활용해서 손쉽게 구현하는 방법을 알아본다. (리포지토리는 정보 저장을 추상화할 때 사용하는 것으로 API를 호출해 다른 곳에 저장하는 것도 그 범주에 둘 수 있지만) 데이터베이스를 사용하는 것이 대부분의 애플리케이션 구성이므로 EF Core를 함께 사용해서 리포지토리 패턴을 구현해 보려고 한다. EF Core 자체가 리포지토리 / 유닛오브워크 패턴을 구현하고 있기 때문에 상당 부분이 델리게이트 형식을 취할 것이고, 코드 반복을 줄이기 위해 제네릭 리포지토리를 사용한다.</p>
<!--more-->
<h2>제네릭 리포지토리</h2>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public interface IRepository&lt;T, I&gt; where T : IEntity where I : struct
{
    Task&lt;T&gt; GetByIdAsync(I id);
    Task AddAsync(T entity);
    void Delete(T entity);
}</code>
        </deckgo-highlight-code>
<p>타입 <code>T</code>는 <code>IEntity</code>를 상속하는 클래스여야 하고 <code>I</code>는 int 또는 guild가 될 수 있는 ID 타입이다. <code>IEntity</code>는 <code>Id</code> 속성만을 정의하는데 이는 EF Core가 다루는 엔티티가 되기 위한 기본조건이다.</p>
<p>리포지토리는 메모리에 존재하는 컬렉션처럼 동작한다. 리스트의 아이템을 개별로 변경하면서 특별히 업데이트라는 메서드를 사용하지 않는 것처럼 리포지토리도 업데이트 기능은 필요없다. 아이템은 변경하려면 일단 ID로 조회하고 그 내용을 변경한다.생성을 포함한 모든 변경 내용은 유닛오브워크가 제공하는 저장 기능을 통해 최종 변경된다. 각각의 리포지토리가 저장 기능을 갖고 있다면 다른 리포지토리와 연계된 변경 내용을 동시 트랜잭션으로 처리할 수 없는 결함이 생긴다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class Repository&lt;T, I&gt; : IRepository&lt;T, I&gt; where T : Entity where I : struct
{
    private readonly ApplicationContext context;
    
    public Repository(ApplicationContext context)
    {
        this.context = context;
    }
    
    public async Task&lt;T&gt; GetByIdAsync(I id)
    {
        var entity = await context.Set&lt;T&gt;().FindAsync(id);
        if(entity == null) throw new EntityNotFoundException(typeof(T).Name, id);
        
        return entity;
    }

    public async Task AddAsync(T entity) =&gt; await context.Set&lt;T&gt;().AddAsync(entity);

    public void Delete(T entity) =&gt; context.Set&lt;T&gt;().Remove(entity);
}</code>
        </deckgo-highlight-code>
<p><code>Repository</code> 클래스는 <code>IRepository</code> 인터페이스에 대한 기본 구현이며 도메인 엔티티의 부모 클래스 역할을 한다. 생성자를 통해 <code>DbContext</code>를 받고 이 것을 통해 데이터베이스를 조작한다. 앞서 언급한 대로 EF Core의 <code>DbSet</code>에 실행을 위임하고 있기 때문에 래퍼정도로 밖에 보이지 않는다.</p>
<h2>도메인 리포지토리</h2>
<p>데이터베이스에 저장되는 도메인 엔티티를 다루기 위해 도메인 리포지토리를 사용한다. 제네릭 리포지토리를 통해 구현한 기능을 상속하므로 기본 기능만으로 충분한 리포지토리라면 특별히 추가할 할 작업이 없다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class Sites : Repository, IDomainRepository
{
}</code>
        </deckgo-highlight-code>
<p>아래 다이어그램은 그 관계를 보여주는데 <code>DomainRepository</code>를 보자. 정의는 <code>IDomainRepository</code>를 구현해야 하도록 정의했지만 실제 구현은 <code>Repository</code>를 상속하는 것으로 해결한다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/aba3eed301b7ebe6c08f221d7015de13/5df5d/repository-inheritance-hierarchy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 69%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABk0lEQVQ4y31T14oCQRC8//8sFRVBBOODCXOcTW401VF99DDuqQ2lzEx3dar9AYDH44Hr9Yrn88mj/PPMez27b59A++GPH4SI4wTT6RTdbhez2QxFUSBN07dBn4zvQhiGIfI8x2AwQLVaRa/XQ5Zl8H3/X9DtdkOSJILdbgdjjCQmbIWHwwGdTkfQ7/exWq0QRRG22y0ul4slYFAQBDidTpK0Uqmg2WxiuVyKnyX0PA/tdhutVkvItTWScI5uy/f7XYLjOMZ+v8f5fJbk7MgS8pEPbJ1t8EyQ8JuxYi7vZYblQTO7btd1LG+ZxqqU8GXLbkus7J1cyn5aIdXgvtkKlaSc8Zts3E5eKjSehyRJsV6vMRwOsdlsZH66OdeCMMLxeMR4PBbf0WgkcZw/JSWE3NZkMpFN12o1kQ6XRGLOiRoVZJnozhgP8/lcPgBC9cju/io0Bo1GA/V6HYvFws5FBU9HgvcUe5HnIh8XvLeEDKQ4WTpb1c+OCyob35mElSvoz/HYljlchVZDMHN522UfBcm45V825jwx3rnTlQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Repository Interface Hierarchy"
        title="Repository Interface Hierarchy"
        src="/static/aba3eed301b7ebe6c08f221d7015de13/5a190/repository-inheritance-hierarchy.png"
        srcset="/static/aba3eed301b7ebe6c08f221d7015de13/772e8/repository-inheritance-hierarchy.png 200w,
/static/aba3eed301b7ebe6c08f221d7015de13/e17e5/repository-inheritance-hierarchy.png 400w,
/static/aba3eed301b7ebe6c08f221d7015de13/5a190/repository-inheritance-hierarchy.png 800w,
/static/aba3eed301b7ebe6c08f221d7015de13/c1b63/repository-inheritance-hierarchy.png 1200w,
/static/aba3eed301b7ebe6c08f221d7015de13/5df5d/repository-inheritance-hierarchy.png 1572w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><code>IDomainRepository</code> 인터페이스는 제넥릭 리포지토리의 기능을 확장하기 위한 장치다. 애그리게이트 루트를 다룰 때 그 예를 확인할 수 있다. 아래 예는 <code>Site</code>를 다루는 리포지토를 API 컨트롤러에서 사용하는 예다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">[ApiController]
[Route(&quot;api/[controller]&quot;)]
public class SiteController : ControllerBase
{
    private readonly IUnitOfWork uow;

    public SiteController(ILogger&lt;StationController&gt; logger, IUnitOfWork unitOfWork)
    {
        uow = unitOfWork;
    }

    [HttpGet(&quot;id&quot;)]
    public async Task&lt;IActionResult&gt; Get(int id)
    {
        var sites = await uow.Sites.GetByIdAsync(id);
        
        return Ok(sites);
    }
}</code>
        </deckgo-highlight-code>
<p>모든 리포지토리는 유닛오브워크를 통한다. 그래서 생성자에서는 유닛오브워크만 필요하고 이 것은 마치 게이트웨이처럼 모든 리포지토리를 생성없이 사용할 수 있게 해준다.</p>
<h2>Unit of work</h2>
<p>조회도 그렇고 변경 내용도 유닛오브워크를 통해 저장한다. 유닛오브워크는 리포지토리의 컨테이너라고 생각할 수 있다. 각 리포지토리의 생성 및 변경 내용을 관리하면서 클라이언트 코드가 필요한 단 하나의 액세스 포인트를 제공한다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3cf3c2c84113cd99aeca5ea39731cac1/7970d/unit-of-work.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXElEQVQoz5WSW6uCQBSF/f//yB57iEKpkMoLEVEGRV4q75auw9rnjJicC2dg4YzOfLP2cmsA8Hq9kGUZ6roW5Xku7zjatsV/hqaAQRDANE0sFgs8Hg9UVdUBFVTNf1MHDMMQq9UKy+UScRzj+Xy+Oew7Hbrur7WfrA9dcTCOIIxQFAVOpxM2m408y7KUqmhC46YwihFFETzPE91uty7TPryQg4nMGdHxeMT5fBbQ/X6X/RqzStNMbtJ1HaPRCJfLRVxQfSAPuq6L8XiM2WyG3W4n78mgQwE2TYP1eo3pdArDMLDdbiXTNE0lS/5xzglnzizTsizJmnCeV1AB8tbD4SCuaJ/iRwKYzVvJX1CWRzEarq/Xq6gD7vd7uc1xHNi2LS7prt86qhtY5mQykRabz+dyhiYI53eNmwn9TsOWoQNWw4h83xeX6u8mSfLp8K/OHzY2XagnRRgrodjYH+7rTsgJXpCNAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Unit of work"
        title="Unit of work"
        src="/static/3cf3c2c84113cd99aeca5ea39731cac1/5a190/unit-of-work.png"
        srcset="/static/3cf3c2c84113cd99aeca5ea39731cac1/772e8/unit-of-work.png 200w,
/static/3cf3c2c84113cd99aeca5ea39731cac1/e17e5/unit-of-work.png 400w,
/static/3cf3c2c84113cd99aeca5ea39731cac1/5a190/unit-of-work.png 800w,
/static/3cf3c2c84113cd99aeca5ea39731cac1/c1b63/unit-of-work.png 1200w,
/static/3cf3c2c84113cd99aeca5ea39731cac1/29007/unit-of-work.png 1600w,
/static/3cf3c2c84113cd99aeca5ea39731cac1/7970d/unit-of-work.png 1908w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>유닛오브워크는 <code>DbContext</code>를 감춘다. <code>DbContext</code>에 접근한다는 의미는 데이터베이스 조작에 필요한 모든 것을 할 수 있다는 의미이기 때문에 이런 위험을 유닛오브워크를 통해 예방할 수 있다. 아래에 간단한 구현 내용이 있다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public interface IUnitOfWork : IDisposable
{
    ISiteRepository Sites { get; }
    ICampaignRepository Campaigns { get; }
    
    Task&lt;int&gt; SaveChangesAsync();
}

public class UnitOfWork : IUnitOfWork
{
    private readonly ApplicationContext context;
    public ISiteRepository Sites { get; }
    public ICampaignRepository Campaigns { get; }

    public UnitOfWork(ApplicationContext context)
    {
        this.context = context;

        Sites = new SiteRepository(context);
        Campaigns = new CampaignRepository(context);
    }
    
    public Task&lt;int&gt; SaveChangesAsync()
    {
        return context.SaveChangesAsync();
    }

    public void Dispose()
    {
        context?.Dispose();
    }
}</code>
        </deckgo-highlight-code>
<p>아래는 단위 테스트의 한 가지 예다. <code>CreateCampaignCommand</code>를 통해 <code>Campaign</code>을 생성하면서 <code>Proposal</code> 엔티티도 걑이 생성하고 있는지 확인하는 테스트다. 리포지토리와 유닛오브워크를 모킹하고 서로 연결한 후, 기대하는 리포지토리 메서드가 호출됐는지, 마지막으로 유닛오브워크의 <code>SaveChangesAsync()</code> 메서드가 호출되었는지 확인한다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class CreateCampaignCommandTests
{
    [Fact]
    public async Task ShouldCreateCampaign()
    {
        var campaignRepo = new Mock&lt;ICampaignRepository&gt;();
        var uow = new Mock&lt;IUnitOfWork&gt;();
        uow.Setup(u =&gt; u.Campaigns).Returns(campaignRepo.Object);

        var command = new CreateCampaignCommand{ Title = &quot;Test Campaign&quot;};
        var sut = new CreateCampaignCommand.Handler(uow.Object);

        await sut.Handle(command, CancellationToken.None);

        campaignRepo.Verify(cr =&gt; cr.AddAsync(It.IsAny&lt;Campaign&gt;()), Times.Once);
        campaignRepo.Verify(cr =&gt; cr.AddProposalAsync(It.IsAny&lt;Proposal&gt;()), Times.Once());
        uow.Verify(u =&gt; u.SaveChangesAsync());
    }
}</code>
        </deckgo-highlight-code>
<h2>애그리게이트 루트 (Aggregate root)</h2>
<p>리포지토리 개념에서 애그리게이트는 관련된 엔티티의 집합이며 루트는 그 엔티티중에 대표적인 엔티티를 일컫는다. <code>Order</code>와 그에 속한 <code>LineItem</code>을 다루면서 각각의 리포지토리를 사용하는 것보다는 <code>Order</code>를 통해 <code>LineItem</code>까지 관리하는 것이 합리적이다.</p>
<p>아래 다이어그램은 <code>Station</code> 엔티티가 <code>SalesHouse</code>를 포함하면서 그 것에 대한 메서드를 품고 있는 것을 보여준다. <code>IStationRepository</code>는 제네릭 리포지토리에서 상속하는 메서드 외에 <code>SalesHouse</code>를 위한 추가적인 세 개의 메서드를 정의하고 있다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b5cb35731f88a7e0b680cfbddeefb3b2/81ebd/aggregate-root.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoElEQVQ4y3WT14rCYBCFff93Ui8EwYK9gXqhoFgTN7bEdpZv1pEo68CQv5z/TDmTTJJcdDqddDgctN/vbZ0kiR6PhzkWJ4mOx6PiODYHh4Njfz6fdb1eDZv5iSJFUaRCoaBsNqvFYmGk9/tdbgTjETYejw2Xy+U0nU7tjDsCGuFut9NoNNJgMNBwONR2u9VqtTISopMFZ71eT51OR41GQ7VaTc1mU61WS91u14KQsRGGYah8Pq9yuWwPKZNoEN1uN9sDhqRYLKper6tarapSqRghCYHzCjJkET3LhhwiSvb+WQ/j2DImEHfggiAwksvlTwMwRuiP6Jn3wc1J+XKPs+YxWPaI4ZUYoS/SaacVTmeaNvCfBjaTJqDc9N7Jzs9xIRtKp9fr9drWlMwd39fY4CiNkvQHYNrWm43m87mRtNttExBhmArwTAXiGGEQhiY7ZP1+36Ivl0tT1gc5DAMjnEwmms1mJoj3jazBIMzb2JRKJcsA87/AhaC333rpLXqpDBhSJ2H/OTbs6RHkZJZ2znzU3sbmW2TMZ41g/7kHhPAXaqnnvfC8fxcAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Aggregate root"
        title="Aggregate root"
        src="/static/b5cb35731f88a7e0b680cfbddeefb3b2/5a190/aggregate-root.png"
        srcset="/static/b5cb35731f88a7e0b680cfbddeefb3b2/772e8/aggregate-root.png 200w,
/static/b5cb35731f88a7e0b680cfbddeefb3b2/e17e5/aggregate-root.png 400w,
/static/b5cb35731f88a7e0b680cfbddeefb3b2/5a190/aggregate-root.png 800w,
/static/b5cb35731f88a7e0b680cfbddeefb3b2/c1b63/aggregate-root.png 1200w,
/static/b5cb35731f88a7e0b680cfbddeefb3b2/29007/aggregate-root.png 1600w,
/static/b5cb35731f88a7e0b680cfbddeefb3b2/81ebd/aggregate-root.png 1868w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>여기서 한 단계 더 깊이 생각해 볼 필요가 있는데, 단순히 하나의 <code>Station</code>만 조회하던 <code>GetByIdAsync(id)</code>가 <code>SalesHouse</code>를 포함하는 오브젝트 그래프를 반환해야 한다는 점이다. <code>GetByIdAsync(id)</code>를 다시 구현하면서 <code>new</code> 키워드로 제넥릭 메서드를 무시할 수 있다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">// StationRepository.cs
public new async Task&lt;Station&gt; GetByIdAsync(int id)
{
    var station = await context.Stations
        .Include(s =&gt; s.SalesHouse)
        .SingleOrDefaultAsync(s =&gt; s.Id == id);
    
    if (station == null) throw new EntityNotFoundException(&quot;Station&quot;, id);
    
    return station;
}</code>
        </deckgo-highlight-code>
<h2>결론</h2>
<p>리포지토리-유닛오브워크 패턴이 DbSet-DbContext에 실행을 위임하고 있기 때문에 이 패턴이 과연 유용한 건지에 대한 의문이 여전히 존재한다. [리포지토리 패턴과 엔티티 프레임워크 코어](리포지토리 패턴과 엔티티 프레임워크 코어) 글을 통해 일부 장점을 살펴봤지만 꼭 사용해야 한다는 의미는 아니다. 이 패턴을 더 이상 사용하지 않는다는 <a href="https://www.thereformedprogrammer.net/">John Smith의 블로그</a>를 통해 많은 인사이트를 얻을 수도 있다.</p>
<p>만약 패턴을 사용하기로 결정했다면 이 글에서 소개한 제네릭 리포지토리를 통해 코드 중복을 줄이자. 또한, 유연한 상속구조를 통해 애그리게이트를 쉽게 구현할 수 있으니 좀더 DDD스러운 엔티티를 관리할 수 있을 것이다.</p></div></div></div><footer class="footer-module--container--5GliC"><div class="footer-module--footer--Z1xkR">My new Gatsby Blog 2019</div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/제네릭-리포지토리/";window.___webpackCompilationHash="a7e105900d1278046e0c";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-82df740e7cad994d0af0.js"],"app":["/app-0c385512a1f64cc6d7f4.js"],"component---src-pages-404-js":["/component---src-pages-404-js-0e83c4e916c6a584f6a1.js"],"component---src-pages-about-js":["/component---src-pages-about-js-236d410604323c4aaa79.js"],"component---src-pages-index-js":["/component---src-pages-index-js-740cf792298a614a522c.js"],"component---src-templates-post-js":["/component---src-templates-post-js-8b3119005e232a8c0f47.js"]};/*]]>*/</script><script src="/polyfill-82df740e7cad994d0af0.js" nomodule=""></script><script src="/app-0c385512a1f64cc6d7f4.js" async=""></script><script src="/framework-ece53a4dfa3f421a9587.js" async=""></script><script src="/webpack-runtime-ac1ba28d15bf0e2ece1e.js" async=""></script></body></html>