<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.5"/><style data-href="/styles.574ccb2304c189c50186.css" data-identity="gatsby-global-css">body{font-family:Arial,Helvetica,sans-serif;font-size:17px;line-height:22px;margin:0}._404-module--content--39436{background-color:#fafafa;padding:20px}._404-module--content--39436 ._404-module--header--15698{color:red}._404-module--content--39436 ._404-module--error-message--76252{color:gray;font-size:20px}.layout-module--container--46809{min-height:100vh;position:relative}.layout-module--container--46809 .layout-module--content--1704e{margin:0 auto;max-width:960px;padding-bottom:100px}.layout-module--container--46809 .layout-module--content--1704e a{color:#000}@media screen and (min-width:1px)and (max-width:1000px){.layout-module--container--46809 .layout-module--content--1704e{padding-left:20px;padding-right:20px}}.header-module--container--8b59b{margin:50px auto 0;max-width:960px;min-height:140px;padding-top:30px}.header-module--container--8b59b .header-module--row--3cc44{padding:5px;text-align:center}.header-module--container--8b59b .header-module--button--31197,.header-module--container--8b59b .header-module--button-github--f7d0c,.header-module--container--8b59b .header-module--button-icon--94669,.header-module--container--8b59b .header-module--button-linkedin--6c28d,.header-module--container--8b59b .header-module--button-twitter--6bc47{background-color:#222f3e;color:#fff;display:inline-block;font-family:Verdana,Geneva,Tahoma,sans-serif;font-size:12px;font-weight:700;height:30px;line-height:30px;margin-bottom:10px;margin-right:10px;min-width:15px;padding-left:10px;padding-right:10px;text-transform:uppercase}.header-module--container--8b59b .header-module--button--31197:hover,.header-module--container--8b59b .header-module--button-github--f7d0c:hover,.header-module--container--8b59b .header-module--button-icon--94669:hover,.header-module--container--8b59b .header-module--button-linkedin--6c28d:hover,.header-module--container--8b59b .header-module--button-twitter--6bc47:hover{background-color:#0984e3}.header-module--container--8b59b .header-module--button-github--f7d0c,.header-module--container--8b59b .header-module--button-icon--94669,.header-module--container--8b59b .header-module--button-linkedin--6c28d,.header-module--container--8b59b .header-module--button-twitter--6bc47{background-position:50%;background-repeat:no-repeat;background-size:16px 16px}.header-module--container--8b59b .header-module--button-github--f7d0c{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMFzkb2YICAAAA6klEQVQoz42RP0oDcRhE3y8gaFIJplAhWgXcQJoFwT6VkCJlDpALeAALS8scwBPEK+gBTCGCf1hwYRU3zRYWhsTqWShBiKu+8mOYYb6Bv7Fr3+rStWrfLgTwloiCY+7ZZAvImbDHCRvchRZgYRkFVICsND0DbDordZjZxJG/MQpmNIArLnhnnRryxis1DomAJ5yq5wZj40XF2NgVL9UpJuoumJouBKkpuK8mFcZI/mOHHBhjRz34tP0eAfbUDuDQa3eWXt320SEEAAcc8UJCwZzAKnVa1DkNZ18CACPabLOGzHnmJjz8Y2eAD7/5vvjSJOIHAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTEwLTI0VDEyOjIzOjU3KzAyOjAwzxYwVwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0xMC0yNFQxMjoyMzo1NyswMjowML5LiOsAAAAZdEVYdFNvZnR3YXJlAHd3dy5pbmtzY2FwZS5vcmeb7jwaAAAAAElFTkSuQmCC)}.header-module--container--8b59b .header-module--button-twitter--6bc47{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMIBW5Bk7VAAAA0ElEQVQoz4WRvWoCYRRE5xN0GxEb0Wq1CIKdYGGRQlIL+ggW8YFWSJEUtr6AjaCihVVsBUMkEEgtdsE/ciyM+q2r7Cnv3Bkuc6UQTHBERlVF1TdfEgnh0CJmyRVWAKx5Y0BKPAET0ueFby4MaYg8AD80cSVy2LSPnv558EHHt1CTRJExf9zGPSYs7shLSYpIetbnzQpGp7sdXlgH/Bvy/wlmo7mcgN8zdi4luj7/lPhFTPLIKztL9qxuKdOzpF8m1APPIquCHrTVu2ZmH/bfKw47VepU/0v6uQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMC0yNFQxMjozMjoyMSswMjowMIhPuIoAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTAtMjRUMTI6MzI6MjErMDI6MDD5EgA2AAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAABJRU5ErkJggg==);margin-right:0}.header-module--container--8b59b .header-module--button-linkedin--6c28d{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAADdcAAA3XAUIom3gAAAAHdElNRQfiChgMHzpKCVmwAAAAi0lEQVQoz82QIQ7CQBBF3zYISBpO0XABDAaFQdaSIFZwoJ4DRYIjnAIcqoYKLAd4iJISsjQIDE9M/mT+/EwGV9buzenDWtXYN884Azzrx4Tc6JQfsKV6KYeu3Xn3aAGDZGPMgTkAC04uU0MkdHrEJksMgSslM24AlOkNjRMAq7ZNE7bh8v6oL/yD4QFJWUru4kp6/AAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMC0yNFQxMjozMTo1OCswMjowMPwlT0MAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTAtMjRUMTI6MzE6NTgrMDI6MDCNePf/AAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAABJRU5ErkJggg==)}.header-module--container--8b59b .header-module--link--8ce94{color:#222f3e;font-family:Verdana,Geneva,Tahoma,sans-serif;font-size:17px;font-weight:700;text-decoration:none}.header-module--container--8b59b .header-module--link--8ce94:hover{color:#0984e3}.header-module--container--8b59b .header-module--link--8ce94:not(:last-child){padding-right:30px}.footer-module--container--e4696{background-color:#222f3e;bottom:0;height:100px;position:absolute;width:100%}.footer-module--container--e4696 .footer-module--footer--675c6{color:#fff;font-family:Verdana,Geneva,Tahoma,sans-serif;height:100px;line-height:100px;margin:0 auto;max-width:960px;padding:0 20px}.title-module--container--9830f{border-bottom:5px solid #576574;color:#576574;margin-bottom:30px;padding-bottom:10px;text-align:center;text-transform:uppercase}.title-module--container--9830f .title-module--title--71b50{font-size:50px;line-height:60px}.title-module--container--9830f .title-module--subtitle--0d166{font-size:18px;font-weight:100}.article-module--article-box--1af62{border-bottom:1px dotted #777;box-shadow:inset 0 0 0 0 #fff;display:inline-block;margin-bottom:30px;transition:all .25s ease;width:100%}.article-module--article-box--1af62:hover{cursor:pointer}@media screen and (min-width:960px){.article-module--article-box--1af62:hover{box-shadow:inset 960px 0 0 0 #dfe6e9}}.article-module--article-box--1af62 .article-module--left--302a9{background-color:#fafafa;float:left;height:150px;width:150px}.article-module--article-box--1af62 .article-module--right--75d6f{color:#222f3e;margin-left:150px;margin-top:-20px;padding:15px}.article-module--article-box--1af62 .article-module--right--75d6f .article-module--date--8c592{font-size:12px;margin-bottom:20px;margin-top:-15px}.article-module--article-box--1af62 .article-module--right--75d6f h3{color:#222f3e}.post-module--container--7b4d6 .post-module--content--b6718{padding:20px}.post-module--container--7b4d6 .post-module--content--b6718 h1{color:#222f3e;line-height:50px;margin-bottom:30px}.post-module--container--7b4d6 .post-module--content--b6718 h2{color:#576574;line-height:30px;margin-bottom:30px;margin-top:30px}.post-module--container--7b4d6 .post-module--content--b6718 h3{color:#576574;line-height:25px;margin-bottom:30px;margin-top:30px}.post-module--container--7b4d6 .post-module--content--b6718 p{font-size:18px;line-height:30px;margin-bottom:10px;text-align:justify}</style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--46809"><header class="header-module--container--8b59b"><div class="header-module--row--3cc44"><a href="/"><div class="header-module--button--31197">Jake the dev</div></a><a href="https://www.github.com/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-github--f7d0c"> </div></a><a href="https://www.linkedin.com/in/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-linkedin--6c28d"> </div></a><a href="https://twitter.com/jakeryu" target="_blank" rel="noopener noreferrer"><div class="header-module--button-twitter--6bc47"> </div></a></div><div class="header-module--row--3cc44"><a class="header-module--link--8ce94" href="/">ARTICLES</a><a class="header-module--link--8ce94" href="/about">ABOUT</a></div></header><div class="layout-module--content--1704e"><div class="post-module--container--7b4d6"><div style="width:100%;height:640px;background-color:#fafafa;background-image:Url(https://picsum.photos/seed/middleware/960/640);background-size:cover;background-repeat:no-repeat;margin-bottom:30px"></div><section class="title-module--container--9830f"><h1 class="title-module--title--71b50">ASP.NET Core 미들웨어</h1><div class="title-module--subtitle--0d166"></div></section><div class="post-module--content--b6718"><p>ASP.NET에서는 <code>System.Web</code> 을 사용하여 http 요청을 처리해 왔고 데이터 운반책인 <code>HttpContext.Current</code>는 32KB의 메모리를 차지했다. 이 것은 요청하는 웹 페이지의 복잡도에 상관없이 하나의 세션당 무조건 필요한 메모리 크기이므로 다소 불합리하다고 할 수 있었다. ASP.NET 5의 http 요청 처리는 Node.js 스타일의 raw socket 과 유사하게 변경되었고 단지 3KB의 메모리만을 차지한다. 이렇게 90% 감소된 메모리 사용은 로딩 타임을 줄여 사용자 요청에 빠르게 응대하고 동시에 더 많은 요청을 처리할 수 있게 해준다. 이런 성능 향상의 배경에 미들웨어가 있다. <!--more--></p>
<h1>미들웨어 아키텍쳐</h1>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 639px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bc598343d84129957a5350a59f59026e/738b8/middleware-architecture.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 37.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB4UlEQVQoz2WR0U9SURzHeeyxl/6mHtraWjz3wCKh1tYD6yFri1YNWJdAQcmSJOHCDTDHsJmtpkso0etF3XQjhFqZgIglWNNx76fBdbTlb/vs9/2cc3Z2dn4GjkvTtF7/dVBht/mNRus7jeY/9lpb/DzYPrHe8c75P4f7GNqqho5K5061fcSb9SBR+SEJxUVccRJXXEjLTpKKQGrVhyQ7ednbc5LIu4jIDyhUFjBwoo5IrYzTJ77DJMqYxByXIwtcj2W5lc5jm5S5kVzCEs5geiF3ufR8jduTIqWdeQxzGxWyhRqdvrXbhHaL2GKEm94ogjuI4Aly57GE1T/HoG8Mrz+Mc1DCMvwed8SDV3TzKDSAPTHKZv0jhos+BWtoDeNQnqfpT5TWl7gvCaTtRhg+12XFfhbPXRsEzqOOGKkLFxAcJsidhsUzkD1FdOoqGzUFQ664Q/5LnVyxxnajCepv4nIM21AKp38Cl0+i3zeFxZ/tZocvzr2BJJbAB1yRZwjiExyhUeyJMf2F//+gph0ysTyCVYxjFmcwi9P0ia+5Jqa7ucOV6LTu428xh2cwhWbpfxXgc3VWn7Lam7KGprb5Wl+lWJ2nXMtSrmYoVbNsHudyreMZ3Wu6l3cyFCoZ9lo/+AvKZAgalUrXtgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="미들웨어 아키텍쳐"
        title="미들웨어 아키텍쳐"
        src="/static/bc598343d84129957a5350a59f59026e/738b8/middleware-architecture.png"
        srcset="/static/bc598343d84129957a5350a59f59026e/772e8/middleware-architecture.png 200w,
/static/bc598343d84129957a5350a59f59026e/e17e5/middleware-architecture.png 400w,
/static/bc598343d84129957a5350a59f59026e/738b8/middleware-architecture.png 639w"
        sizes="(max-width: 639px) 100vw, 639px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>&#x3C;그림 1> 미들웨어 아키텍쳐</p>
<p>그림에서 OWIN Server 영역 내에 있는 것은 모두 미들웨어이고 마지막 미들웨어가 최종 응답을 생성하고 있어서 애플리케이션의 역할을 한다고 볼 수 있다. 좋은 예로 MVC 6는 애플리케이션 역할을 하는 미들웨어다. 이렇게 미들웨어의 체인에서는 중간 과정의 어떤 미들웨어던지 응답을 반환하는 것으로 작업을 마칠 수 있어서 아주 유연하고 확장성이 좋다.</p>
<p>미들웨어는 OWIN에서 그 개념을 가져왔지만 <code>HttpContext</code> 와 <code>RequestDelegate</code>만을 높은 수준에서 추상화한 작은 개념이다. 미들웨어는 요청 파이프라인에서 콘텍스트 객체를 통해 정보를 읽고 쓸 수 있다. 또한 응답을 반환함으로써 파이프라인을 종료하거나, 다음 미들웨어를 호출하여 작업을 이어갈 수 있다. 미들웨어 간의 호출은 비동기로 이루어지기 때문에 서버 리소스 활용 측면에서도 효율적이다.</p>
<p>미들웨어를 구현하려면 <code>HttpContext</code>를 인자로 받고 <code>Task</code> 객체를 반환하는 메소드(리플렉션으로 찾기 때문에 메서드 명은 상관없다)와, <code>RequestDelegate</code>를 입력 인자로 받는 생성자를 클래스에 정의하면 된다.</p>
<p>&#x3C;리스트 1> 미들웨어 구현</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public class MyMiddleware
{
    private readonly RequestDelegate _next;

    public MyMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext context)
    {
        // do something
        // ...

        // call next middleware
        await _next(context);
    }
}</code>
        </deckgo-highlight-code>
<p><code>Invoke</code> 메서드의 <code>HttpContext</code>는 <code>System.Web</code>이 아닌 <code>Microsoft.AspNet.Http</code> 네임스페이스에 있다. 이것으로 HTTP 요청처리 방식이 변경되었다는 사실을 알 수 있다. 생성자로 받는 <code>RequestDelegate</code>의 정의를 추적해 보면 미들웨어가 되기 위한 요건 중 꼭 있어야 할 메서드의 정의와 동일하다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public delegate Task RequestDelegate(HttpContext context);</code>
        </deckgo-highlight-code>
<p>즉, 미들웨어 생성과 함께 다음에 호출할 미들웨어를 전달 받아 보관한 후, 필요한 시점에 다음 미들웨어로 프로세스를 넘길 수 있는 구조이다. 미들웨어 사용은 <code>Startup</code> 클래스의 <code>Configure()</code> 메서드에서 <code>app.UseMiddleware&#x3C;MyMiddleware>()</code> 메서드를 사용하여 구성한다.</p>
<p>미들웨어를 구성할 때, 이렇게 선형적(linear) 방식 뿐 아니라 분기(branch)할 수 있는 방법도 제공한다. 예를 들어, 에러 처리를 위한 미들웨어를 구성한다고 할 때, 오류시 에러 페이지를 반환한다고 하자. 그러나, API에 대한 요청은 JSON 또는 XML 포맷의 응답을 기대할 것이기에 여기에 html 페이지를 반환하는 것은 이해할 수 있는 구성이 아닐 것이다. 아래 코드에서는 <code>/api</code> URL로 들어오는 요청에 대해 다른 구성 메서드로 분기하는 방법을 보여준다.</p>
<p>&#x3C;리스트 2> 미들웨어 분기</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">using Microsoft.AspNet.Builder;
using Microsoft.AspNet.Http;

namespace MyApplication
{
	public class Startup
	{
		public void Configure(IApplicationBuilder app)
		{
			app.Map(&quot;/api&quot;, ConfigureApi);

			app.Run(async (context) =&gt;
			{
				await context.Response.WriteAsync(&quot;Hello World!&quot;);
			});
		}

		private void ConfigureApi(IApplicationBuilder app)
		{
			app.Run(async (context) =&gt;
			{
				await context.Response.WriteAsync(&quot;Hello World from API!&quot;);
			});
		}
	}
}</code>
        </deckgo-highlight-code>
<p>미들웨어의 분기적인 구성에 대해 자세한 내용은 다음 링크에서 확인할 수 있다.</p>
<p><a href="http://blog.dudak.me/2015/non-linear-middleware-chains-in-asp-net-5">Non-linear middleware chains in ASP.NET 5</a></p>
<h1>호스팅 환경의 영향</h1>
<p>개발자가 직접 요청 파이프라인을 구성하는 방식때문에 해당 구성이 없으면 간단한 html 페이지도 브라우저에 보낼 수 없다 (성능이 대폭 향상된 근본적인 이유이다). 그러나, <code>app.UseStaticFiles()</code>처럼 많은 확장 메서드들이 편의를 위해 제공되므로 기본적인 작업 때문에 개발자가 수고를 들일 필요는 없다.</p>
<p>요청 파이프라인을 스스로 처리할 수 있는 능력 덕분에 셀프 호스팅이 쉬워졌다. <code>Microsoft.AspNet.Server.WebListener</code>처럼 기본적으로 제공되는 호스팅 환경을 사용할 수도 있지만 닷넷 매니지드 코드로 작성된 모든 애플리케이션에서 ASP.NET 5 앱을 호스팅할 수 있다.</p>
<p>만약, static 파일(image, html 등)을 미들웨어를 통해 처리하지 않는데도 불구하고 브라우저에서 볼 수 있다면  호스팅 환경(특히, IIS)에서 파일 시스템에 기반해서 요청을 처리하기 때문이다.</p>
<p>기존 MVC 5 애플리케이션에서도 이런 현상이 있는데, 웹 서버가 애플리케이션보다 요청을 먼저 받고 처리하기 때문에 MVC 입장에서는 정적 파일에 대해 라우팅 전략을 가져가기 어렵다. 이런 현상을 막으려면 RegisterRoutes 메서드의 첫 줄에서 존재하는 파일에 대해 라우팅을 한다고 프레임워크에 알린다.</p>
<deckgo-highlight-code language="csharp" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">public static void RegisterRoutes(RouteCollection routes)
{
    routes.RouteExistingFiles = ture;
    
    ...
}</code>
        </deckgo-highlight-code>
<p>IISExperss 가 간섭하는 것을 막기 위해 설정 파일을(C:\Users\{username}\Documents\IISExpress\config\applicationhost.config)을 열고 UrlRoutingModule-4.0 항목의 perCondition 어트리뷰트에 빈 값을 할당한다.</p>
<deckgo-highlight-code language="html" terminal="carbon" theme="one-light" line-numbers="true"  >
          <code slot="code">&lt;add name=&quot;UrlRoutingModule-4.0&quot; type=&quot;System.Web.Routing.UrlRoutingModule&quot; preCondition=&quot;&quot; /&gt;</code>
        </deckgo-highlight-code>
<p>개인적인 의견이지만 전통적인 ASP.NET + IIS 의 강력한 조합은 ASP.NET 미들웨어의 등장과 함께 재정리되어야 할 것 같다. 웹 서버의 종속성이 없어진 상황에서 웹 서버의 역할을 어떻게 규정해야 할까?</p></div></div></div><footer class="footer-module--container--e4696"><div class="footer-module--footer--675c6">Life is a journey of learning. </div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/middleware/";window.___webpackCompilationHash="6104b8618c8f9d3fa419";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-31951725b1a6558f9f0d.js"],"app":["/app-f6f44375a15ab67f01d4.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a74336b5a57bcf192432.js"],"component---src-pages-about-js":["/component---src-pages-about-js-0f8a2f5ce68f39211e4b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-7840ec1412e79e02b0ed.js"],"component---src-templates-post-js":["/component---src-templates-post-js-db02a83e4b99194c22b6.js"]};/*]]>*/</script><script src="/polyfill-31951725b1a6558f9f0d.js" nomodule=""></script><script src="/app-f6f44375a15ab67f01d4.js" async=""></script><script src="/framework-e1920fffb1cf79c01553.js" async=""></script><script src="/webpack-runtime-d2e8b69cfb56fa34dcbb.js" async=""></script></body></html>